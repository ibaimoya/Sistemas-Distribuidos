<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PokeAPI</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* ----------  ESTILOS  ---------- */
    body{
      margin:0;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden;
      background:linear-gradient(to bottom,rgba(18,128,206,.864),rgba(9,126,198,.461));color:#fff;
    }
    .barraTop{background:rgba(0,0,0,.35);backdrop-filter:blur(4px);}
    #whiteOverlay{position:fixed;inset:0;background:#fff;opacity:1;
                  transition:opacity 2s ease-in-out;pointer-events:none;z-index:1000;}

    @keyframes aparecer{from{transform:translateY(60px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    @keyframes entrarIzq{from{transform:translateX(-120%);opacity:0;}to{transform:translateX(0);opacity:1;}}

    .animEntrada{opacity:0;animation:aparecer .8s ease-out .2s forwards;}
    .animIzq{opacity:0;animation:entrarIzq .7s ease-out forwards;}

    @keyframes fadeOutUp{from{opacity:1;transform:translateY(0);}to{opacity:0;transform:translateY(-50px);}}
    .fadeOutUp{animation:fadeOutUp .5s ease-out forwards;}

    @keyframes moveUp{from{transform:translateY(0);}to{transform:translateY(-15vh);}}
    .moveUp{animation:moveUp .5s ease-out forwards;}

    .search-container{display:flex;flex-direction:column;align-items:center;justify-content:center;
                      min-height:40vh;transition:all .5s ease-out;padding-top:2rem;}

    .pokemon-container{background:rgba(255,255,255,.15);backdrop-filter:blur(10px);border-radius:16px;
                       padding:2rem;margin-top:0;max-width:800px;width:90%;opacity:0;transform:translateY(20px);
                       transition:opacity .5s ease,transform .5s ease;position:relative;top:-190px;}
    .pokemon-container.show{opacity:1;transform:translateY(0);}

    .type-badge{padding:.5rem 1rem;border-radius:20px;font-weight:bold;text-transform:capitalize;margin-right:.5rem;}
    .normal{background:#A8A878}.fire{background:#F08030}.water{background:#6890F0}.electric{background:#F8D030}
    .grass{background:#78C850}.ice{background:#98D8D8}.fighting{background:#C03028}.poison{background:#A040A0}
    .ground{background:#E0C068}.flying{background:#A890F0}.psychic{background:#F85888}.bug{background:#A8B820}
    .rock{background:#B8A038}.ghost{background:#705898}.dragon{background:#7038F8}.dark{background:#705848}
    .steel{background:#B8B8D0}.fairy{background:#EE99AC}

    .stat-bar{height:10px;border-radius:5px;background:rgba(255,255,255,.3);overflow:hidden;margin-bottom:.5rem;}
    .stat-fill{height:100%;background:#4CAF50;}

    .btn-back{position:absolute;top:4rem;left:1rem;z-index:10;background:rgba(0,0,0,.25);border:none;border-radius:50%;
              width:42px;height:42px;display:flex;justify-content:center;align-items:center;color:#fff;font-size:1.6rem;
              transition:background .2s;opacity:0;animation:entrarIzq .7s ease-out .5s forwards;}
    .btn-back:hover{background:rgba(0,0,0,.45);}

    .loader{width:48px;height:48px;border:5px solid #FFF;border-bottom-color:transparent;border-radius:50%;display:none;
            box-sizing:border-box;animation:rotation 1s linear infinite;}
    @keyframes rotation{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

    .error-message{color:#ff6b6b;background:rgba(0,0,0,.2);padding:1rem;border-radius:8px;margin-top:1rem;display:none;}

    .search-input{font-size:1rem;padding:.75rem 1rem;}
    .header-logo{width:40px;height:40px;border-radius:50%;margin-right:10px;}
  </style>
</head>

<body>
  <!-- Overlay -->
  <div id="whiteOverlay"></div>

  <!-- Botón volver -->
  <a href="/menu" class="btn-back fadeLink" title="Volver al menú">
    <i class="bi bi-arrow-left-short"></i>
  </a>

  <!-- Barra superior -->
  <header class="barraTop py-2 px-4 d-flex justify-content-between align-items-center animEntrada" style="animation-delay:.1s;">
    <div class="d-flex align-items-center">
      <img th:src="@{/images/pokedex.png}" class="header-logo" alt="Logo">
      <h4 class="m-0">PokeAPI</h4>
    </div>
    <span class="fw-bold" th:text="${usuarioActual}">Usuario</span>
  </header>

  <!-- Contenido -->
  <main class="flex-grow-1 d-flex flex-column align-items-center">
    <div id="searchContainer" class="search-container">
      <h1 id="searchTitle" class="fw-bold text-center mb-4 animEntrada">Busca un Pokémon</h1>
      <div class="input-group mb-3 animEntrada" style="max-width:700px;width:95%;">
        <input list="textoBuscar" id="pokemonSearch" class="form-control form-control-lg search-input"
               placeholder="Nombre o número del Pokémon" aria-label="Nombre del Pokémon">
        <datalist id="textoBuscar"></datalist>
        <button class="btn btn-light" type="button" id="searchButton"><i class="bi bi-search"></i></button>
      </div>
      <div id="loader" class="loader mt-4"></div>
      <div id="errorMessage" class="error-message">Pokémon no encontrado. Intenta con otro nombre.</div>
    </div>

    <div id="pokemonContainer" class="pokemon-container mx-auto">
      <div class="row">
        <div class="col-md-5 text-center">
          <img id="pokemonImage" src="/placeholder.svg" alt="Imagen del Pokémon"
               class="img-fluid mb-3" style="max-height:250px;">
          <div id="pokemonTypes" class="d-flex justify-content-center flex-wrap gap-2 mb-3"></div>
        </div>
        <div class="col-md-7">
          <h2 id="pokemonName" class="text-capitalize fw-bold mb-3"></h2>
          <div class="mb-4">
            <div class="d-flex justify-content-between mb-2"><span>Altura:</span><span id="pokemonHeight"></span></div>
            <div class="d-flex justify-content-between mb-2"><span>Peso:</span><span id="pokemonWeight"></span></div>
            <div class="d-flex justify-content-between mb-2"><span>Habilidades:</span><span id="pokemonAbilities"></span></div>
          </div>
          <h5 class="mb-3">Estadísticas</h5>
          <div id="pokemonStats"></div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ----------  JS  ---------- -->
  <script>
    /* ---------- carga de nombres para el <datalist> ---------- */
    async function cargarListaPokemon() {
      try {
        const resp = await fetch('http://localhost:5000/api/pokemons');   // nuevo endpoint Flask
        const data = await resp.json();
        const lista = Array.isArray(data) ? data : (data.results || []);
        const datalist = document.getElementById('textoBuscar');

        lista.forEach(pokemon => {
          const option = document.createElement('option');
          option.value = pokemon.name;
          option.textContent = pokemon.name[0].toUpperCase() + pokemon.name.slice(1);
          datalist.appendChild(option);
        });
      } catch (e) {
        console.error('No se pudo cargar la lista de Pokémon:', e);
      }
    }

    /* ---------- helpers visuales ---------- */
    window.addEventListener('load', () => {
      const overlay = document.getElementById('whiteOverlay');
      setTimeout(() => (overlay.style.opacity = '0'), 100);
      setTimeout(() => (overlay.style.display = 'none'), 2100);
    });

    /* ---------- lógica principal ---------- */
    document.addEventListener('DOMContentLoaded', () => {
      cargarListaPokemon();   // se invoca al inicio

      const searchInput      = document.getElementById('pokemonSearch');
      const searchButton     = document.getElementById('searchButton');
      const searchContainer  = document.getElementById('searchContainer');
      const searchTitle      = document.getElementById('searchTitle');
      const pokemonContainer = document.getElementById('pokemonContainer');
      const loader           = document.getElementById('loader');
      const errorMessage     = document.getElementById('errorMessage');

      const pokemonImage     = document.getElementById('pokemonImage');
      const pokemonName      = document.getElementById('pokemonName');
      const pokemonTypes     = document.getElementById('pokemonTypes');
      const pokemonHeight    = document.getElementById('pokemonHeight');
      const pokemonWeight    = document.getElementById('pokemonWeight');
      const pokemonAbilities = document.getElementById('pokemonAbilities');
      const pokemonStats     = document.getElementById('pokemonStats');

      pokemonContainer.style.display = 'none';
      let firstSuccessfulSearch = true;

      async function searchPokemon() {
        const pokemonNameOrId = searchInput.value.trim().toLowerCase();
        if (!pokemonNameOrId) return;

        loader.style.display = 'inline-block';
        errorMessage.style.display = 'none';

        try {
          const resp = await fetch(`http://localhost:5000/api/pokemon/${pokemonNameOrId}`);
          if (!resp.ok) throw new Error('Pokémon no encontrado');

          const pokemon = await resp.json();

          if (firstSuccessfulSearch) {
            searchTitle.classList.add('fadeOutUp');
            firstSuccessfulSearch = false;
          }
          searchContainer.classList.add('moveUp');
          displayPokemonData(pokemon);

        } catch (e) {
          console.error(e);
          errorMessage.style.display = 'block';
          pokemonContainer.style.display = 'none';
        } finally {
          loader.style.display = 'none';
        }
      }

      function displayPokemonData(pokemon) {
        const art = pokemon.sprites.other['official-artwork'].front_default || pokemon.sprites.front_default;
        pokemonImage.src = art;
        pokemonImage.alt = `Imagen de ${pokemon.name}`;
        pokemonName.textContent = pokemon.name;

        /* tipos */
        pokemonTypes.innerHTML = '';
        pokemon.types.forEach(t => {
          const span = document.createElement('span');
          span.textContent = t.type.name;
          span.className = `type-badge ${t.type.name}`;
          pokemonTypes.appendChild(span);
        });

        pokemonHeight.textContent = `${pokemon.height / 10} m`;
        pokemonWeight.textContent = `${pokemon.weight / 10} kg`;
        pokemonAbilities.textContent = pokemon.abilities
                                        .map(a => a.ability.name.replace('-', ' '))
                                        .join(', ');

        /* stats */
        pokemonStats.innerHTML = '';
        pokemon.stats.forEach(s => {
          const pct = (s.base_stat / 255) * 100;
          pokemonStats.insertAdjacentHTML('beforeend', `
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-1">
                <span class="text-capitalize">${s.stat.name.replace('-', ' ')}</span>
                <span>${s.base_stat}</span>
              </div>
              <div class="stat-bar"><div class="stat-fill" style="width:${pct}%"></div></div>
            </div>
          `);
        });

        pokemonContainer.style.display = 'block';
        setTimeout(() => pokemonContainer.classList.add('show'), 100);
      }

      searchButton.addEventListener('click', searchPokemon);
      searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchPokemon(); });

      /* salida con fundido */
      document.querySelectorAll('.fadeLink').forEach(link => {
        link.addEventListener('click', e => {
          e.preventDefault();
          const overlay = document.getElementById('whiteOverlay');
          overlay.style.display = 'block';
          overlay.style.opacity = '0';
          void overlay.offsetWidth;
          overlay.style.opacity = '1';
          setTimeout(() => (window.location.href = link.href), 1500);
        });
      });
    });
  </script>
</body>
</html>